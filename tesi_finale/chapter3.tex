\chapter{Numerical model} \label{chap:discretization} %discretized equations?
In this chapter we describe the methods that are used to discretize the model. 
For the spatial discretization we use the finite volumes method, which allows 
to solve efficiently flow problems guaranteeing the mass conservation. See 
\cite{fv:leveque} for a broad description.
In the free-flow region we discretize the equations using the staggered grid 
concept, while in the porous-medium we employ a cell-centred approach with a 
Two Point Flux Approximation (TPFA).

For the temporal discretization we use implicit finite differences methods, 
like Backward Euler (BE) and the Backward Differencing Formula 2 (BDF2).
%
\section{Staggered grid concept}
The staggered grid concept is characterized by the distinction between the 
degrees of freedom related to scalar primary variables and those related to 
vectorial primary variables. In saddle point problems, like the incompressible 
Navier-Stokes or RANS equations, if we locate all the primary variables, i.e. 
pressure, velocity and possibly the turbulent kinetic energy and its 
dissipation rate, at the same positions in the grid, spurious modes in the 
solution may arise, leading to wrong results. A possible fix to this issue 
is thus to store the variables in a \emph{staggered} fashion, putting 
the degrees of freedom related to scalar variables at the centre of the cells 
and those related to vectorial variables on the faces, aligned to the faces 
normal direction. Therefore we obtain different control volumes, as we can see 
in Figure~\ref{fig:staggrid} for the case of the 
Navier-Stokes equations in a two-dimensional domain.
\begin{figure}[t]
	\centering
	\includegraphics[width=\textwidth]{staggered_grid_mia.pdf}
	\caption[Staggered grid control volumes]{An example of a staggered grid 
	with the pressure degrees of freedom (dofs) stored at the centres of the 
	cells and the velocity dofs stored on the faces. The different control 
	volumes are highlighted. The indices in capital letters 
	$\dots,I-1,I,I+1,\dots$ 
	and $\dots,J-1,J,J+1,\dots$ refer to cells, thus to the position of 
	cell-centred variables, while the indices in lower case letters 
	$\dots,i-1,i,i+1,\dots$ and $\dots,j-1,j,j+1,\dots$ refer to faces, thus to 
	the 
	position of staggered variables.}
	\label{fig:staggrid}
\end{figure}

This approach is known also as Marker and Cell (MAC), as it was called in its 
first appearance in a paper by \textcite{stagg:orig}, within a finite 
differences framework. A more recent description can be found in 
\cite{main:vermal}.

Another advantage of this discretization method is that on the boundary we have 
the degrees of freedom of the normal component of the velocity, so it is easier 
to impose boundary and interface conditions.

For the sake of simplicity we consider now a bi-dimensional domain and 
$\mathbf{v} = [u, v]^{\mathrm{T}}$.
%
\subsection{Cell-centred equations}
\subsubsection{Continuity equation}
The continuity equation \eqref{eq:ransmass} is discretized using control 
volumes that coincide with the cells of the grid, thus it is treated is a 
cell-centred way. Since we are dealing with incompressible fluids, it does not 
involve the density and this makes its approximation easier.
%We will see in section ... how to deal with non constant desities
We integrate over the ``grey'' control 
volume $V_p = [x_{i-1},x_i] \times [y_{j-1},y_j]$, according to 
Figure~\ref{fig:staggrid}, 
and we apply the Gauss's divergence theorem:
\begin{equation}
\int_{V_p} \nabla \cdot \mathbf{v} \; dV = \int_{\partial V_p} \mathbf{v} \cdot 
\mathbf{n} \; dA = 0.
\end{equation}
The integral over the boundary $\partial V_p$ can be split over the four faces, 
that we identify with $e_p$ (east), $n_p$ (north), $w_p$ (west), $s_p$ (south):
\begin{equation}
\int_{\partial V_p} \mathbf{v} \cdot \mathbf{n} \; dA = \int_{e_p} u \; dA
+ \int_{n_p} v \; dA - \int_{w_p} u \; dA - \int_{s_p} v \; dA.
\end{equation}
At this point we discretize the equation approximating the values of the 
velocity with the values at the centre of the faces, for example:
\begin{equation}
\int_{e_p} u \; dA \approx u_{i,J} |e_p|,
\end{equation}
where $|e_p|$ denotes the measure of the face $e_p$. Thus we obtain
\begin{equation}
	u_{i,J} |e_p| + v_{I,j}|n_p| - u_{i-1,J}|w_p| - v_{I,j-1}|s_p| = 0
\end{equation}
\subsubsection{Turbulence model equations}
The equations for the turbulent kinetic energy \eqref{eq:komegak} and the 
specific dissipation rate \eqref{eq:komegaomega} are treated analogously to the 
continuity equation, but they involve more terms. Let us integrate them over 
the same control volume  $V_p = [x_{i-1},x_i] \times [y_{j-1},y_j]$:
\begin{itemize}
	\item the storage terms are approximated with the values at the centre of 
	the cell:
	\begin{equation}
	\int_{V_p} \frac{\partial k}{\partial t} \; dV = \frac{d}{dt} \int_{V_p}k 
	\; dV \approx \frac{dk_{I,J}}{dt}|V_p|,
	\end{equation}
	\begin{equation}
	\int_{V_p} \frac{\partial 
	\omega}{\partial t} \; dV = \frac{d}{dt} \int_{V_p} \omega \; dV \approx 
	\frac{\partial \omega_{I,J}}{\partial t}|V_p|.
	\end{equation}
	%
	\item the Gauss's divergence theorem is applied to the convective terms:
	\begin{equation}
		\int_{V_p} \nabla \cdot (k \mathbf{v}) \; dV = \int_{\partial V_p} k 
		(\mathbf{v} 
		\cdot \mathbf{n}) \; dA,
	\end{equation}
	\begin{equation}
	\int_{V_p} \nabla \cdot (\omega \mathbf{v}) \; dV = \int_{\partial V_p} 
	\omega 
	(\mathbf{v} \cdot \mathbf{n}) \; dA,
	\end{equation}
	then the velocity is approximated with its value at the centre of the face, 
	while for the transported quantities $k$ and $\omega$ we employ the 
	upstream value with respect to the sign of the velocity, so considering for 
	example the face $e_p$ and supposing that $u_{i,J}>0$ we have:
	\begin{equation}
		\int_{e_p} ku \; dA \approx k_{I,J}u_{i,J}|e_p|, \quad \int_{e_p} 
		\omega u \; dA \approx \omega_{I,J}u_{i,J}|e_p|.
	\end{equation}
	Notice that this approach is not the only possible choice, as it will be 
	explained with more details in Subsections~\ref{subsec:diffscheme} and 
	\ref{subsec:tvd}.
	%
	\item the Gauss's divergence theorem is applied to the diffusive terms:	
	\begin{equation}
		\int_{V_p} \nabla \cdot \bigg[\bigg(\nu + 
		\sigma^*\frac{k}{\omega}\bigg) \nabla k\bigg] \; dV = \int_{\partial 
		V_p} \bigg(\nu + \sigma^*\frac{k}{\omega}\bigg) \nabla k \cdot 
		\mathbf{n} \; dA,
	\end{equation}
	\begin{equation}
	\int_{V_p} \nabla \cdot \bigg[\bigg(\nu + \sigma\frac{k}{\omega}\bigg) 
	\nabla \omega\bigg] \; dV = \int_{\partial V_p} \bigg(\nu + \sigma 
	\frac{k}{\omega}\bigg) \nabla \omega \cdot \mathbf{n} \; dA.
	\end{equation}
	Then, considering for example the face $e_p$, the derivatives of $k$ and 
	$\omega$ are approximated with centred finite differences, while the 
	coefficients involving the viscosity are approximated by a weighted average 
	between the values at the centre of the cells sharing the face, thus 
	assuming a linear trend:
	\begin{equation}
	\int_{e_p} \bigg(\nu + \sigma^*\frac{k}{\omega}\bigg) \frac{\partial 
	k}{\partial x} \; dA \approx \bigg(\nu + \sigma^* 
	\frac{k}{\omega}\bigg)_\text{avg} \frac{k_{I+1,J}-k_{I,J}}{x_{I+1}-x_I} 
	|e_p|,
	\end{equation}
	\begin{equation}
	\int_{e_p} \bigg(\nu + \sigma\frac{k}{\omega}\bigg) \frac{\partial 
	\omega}{\partial x} \; dA \approx \bigg(\nu + \sigma 
	\frac{k}{\omega}\bigg)_\text{avg} 
	\frac{\omega_{I+1,J}-\omega_{I,J}}{x_{I+1} - x_I} |e_p|,
	\end{equation}
	where the subscript $_\text{avg}$ denotes the weighted average
	\begin{equation}
	(\ast)_\text{avg} = \frac{x_{I+1} - x_i}{x_{I+1} - x_I}(\ast)_{I,J} + 
	\frac{x_i-x_I}{x_{I+1} - x_I}(\ast)_{I+1,J}.
	\end{equation}
	%
	\item in the source terms all the quantities are approximated with their 
	value at the centre of the cell. We report here only the derivatives 
	appearing in the entries of $\mathbf{S}$, $\nabla k$ and $\nabla \omega$, 
	that are computed with centred finite differences:
	\begin{equation}
		\frac{\partial u}{\partial x}\Big|_{I,J} \approx 
		\frac{u_{i+1,J}+u_{i,J}-u_{i-1,J}-u_{i-2,J}}{2(x_{I+1}-x_{I-1})},
	\end{equation}
	\begin{equation}
	\frac{\partial v}{\partial y} \Big|_{I,J} \approx
	\frac{v_{I,j+1}+v_{I,j}-v_{I,j-1}-v_{I,j-2}}{2(y_{J+1}-y_{J-1})},
	\end{equation}
	\begin{equation}
		\frac{\partial u}{\partial y}\Big|_{I,J} \approx 
		\frac{u_{i,J+1}+u_{i-1,J+1}-u_{i,J-1}-u_{i-1,J-1}}{2(y_{J+1}-y_{J-1})},
	\end{equation}
	\begin{equation}
	\frac{\partial v}{\partial x} \Big|_{I,J} \approx 
	\frac{v_{I+1,j}+v_{I+1,j-1}-v_{I-1,j}-v_{I-1,j-1}}{2(x_{I+1}-x_{I-1})},
	\end{equation}
	\begin{equation}
		\frac{\partial k}{\partial x}\Big|_{I,J} \approx \frac{k_{I+1,J} - 
		k_{I-1,J}}{x_{I+1} - x_{I-1}}, 
		\quad \frac{\partial k}{\partial y}\Big|_{I,J} \approx 
		\frac{k_{I,J+1}-k_{i,J-1}}{y_{J+1}-y_{J-1}},
	\end{equation}
	\begin{equation}
		\frac{\partial \omega}{\partial x}\Big|_{I,J} \approx 
		\frac{\omega_{I+1,J} - \omega_{I-1,J}}{x_{I+1} - x_{I-1}}, \quad 
		\frac{\partial \omega}{\partial y}\Big|_{I,J} \approx 
		\frac{\omega_{I,J+1}-\omega_{i,J-1}}{y_{J+1}-y_{J-1}}.
	\end{equation}
	%
	\item the sink terms are approximated with the values at the centres of the 
	cells:
	\begin{equation}
		\int_{V_p} \beta^* k \omega \; dV \approx 
		\beta^*k_{I,K}\omega_{I,J}|V_p|,
	\end{equation}
	\begin{equation}
		\int_{V_p} \beta \omega^2 \; dV \approx \beta \omega_{I,J}^2 |V_p|.
	\end{equation}
\end{itemize}
%
\subsection{Staggered equations}
The momentum equation \eqref{eq:ransmom2} is discretized using the staggered 
control volumes. Let us consider the equation for the component $u$ of the 
velocity:
\begin{equation} \label{eq:stagu}
\frac{\partial u}{\partial t} + \nabla \cdot ( u \mathbf{v}) - \nabla \cdot 
(\nu_\text{eff} \nabla u) + \frac{1}{\varrho} \frac{\partial}{\partial x} 
\big(p 
+ \varrho k\big) = 0.
\end{equation}
Notice that, since we are considering a two-dimensional model, we have 
substituted the factor $2/3$ with a $1$ in front of $\varrho k$, because it 
came from the requirement \eqref{eq:tracciatau}.

We integrate it over the ``red'' control volume $V_u=[x_I, 
x_{I+1}]\times[y_{j-1},y_j]$, 
according to Figure~\ref{fig:staggrid}, and apply the Gauss's divergence 
theorem:
\begin{multline} \label{eq:stagmomeq}
\int_{V_u} \bigg[ \frac{\partial u}{\partial t} + \nabla \cdot ( u \mathbf{v} ) 
- \nabla \cdot (\nu_\text{eff} \nabla u) + \frac{1}{\varrho} 
\frac{\partial}{\partial x} \big( p + \varrho k \big) \bigg ]\; dV 
=\\
=\frac{d}{dt} \int_{V_u} u\; dV + \int_{\partial V_u} u (\mathbf{v} \cdot 
\mathbf{n}) \; dA - \int_{\partial V_u} \nu_\text{eff} (\nabla u \cdot 
\mathbf{n}) \; dA \; + \\
+\frac{1}{\varrho}\int_{\partial V_u} (p + \varrho k) n_x \; dA = 0,
\end{multline}
where $n_x$ is the component in the $x$ direction of the outward unit 
normal $\mathbf{n}$. Let us identify again the four faces of $\partial V_u$ 
with $e_u$ (east), $n_u$ (north), $w_u$ (west), $s_u$ (south), so that
\begin{equation}
	\partial V_u = e_u \cap n_u \cap w_u \cap s_u.
\end{equation}
In the equation \eqref{eq:stagmomeq} there are four terms of different nature, 
let us consider each of them separately, starting from the simplest one:
\begin{itemize}
	\item in the storage term we approximate the velocity with the value at the 
	centre of the control volume:
	\begin{equation}
	\frac{d}{dt} \int_{V_u}  u\; dV \approx \frac{du_{i,J}}{dt}|V_u|;
	\end{equation}
	%
	\item in the pressure term the contributions from the faces $n_u$ and $s_u$ 
	are null because $n_x=0$ on them, so 
	\begin{equation}
	\int_{\partial V_u} (p + \varrho k)n_x \; dA = \int_{e_u} (p+\varrho k) \; 
	dA - \int_{w_u} (p+\varrho k) \; dA.
	\end{equation}
	Then we approximate $p$ and $k$ with the values at the centre of the faces:
	\begin{equation}
	\int_{e_u} (p+\varrho k) \; dA \approx (p_{I+1,J} +\varrho k_{I+1,J}) |e_u|,
	\end{equation}
	\begin{equation}
	\int_{w_u} (p+\varrho k) \; dA \approx (p_{I,J} +\varrho k_{I,J}) |w_u|.
	\end{equation}
	%
	\item in the diffusive term we have both a frontal momentum flux 
	contribution from the faces $e_u$ and $w_u$ and a lateral momentum flux 
	contribution from the faces $n_u$ and $s_u$:
	\begin{multline}
	\int_{\partial V_u} \nu_\text{eff} (\nabla u \cdot \mathbf{n}) \; dA =     
	\int_{e_u} \nu_\text{eff} \frac{\partial u}{\partial x} \; dA
	- \int_{w_u} \nu_\text{eff} \frac{\partial u}{\partial x} \; dA \;+\\
	+\int_{n_u} \nu_\text{eff} \frac{\partial u}{\partial y} \; dA
	- \int_{s_u} \nu_\text{eff} \frac{\partial u}{\partial y} \; dA
	\end{multline}
	We develop the contributions from $e_u$ and $n_u$, the other two are 
	analogous.\\	
	For the frontal momentum flux we approximate the viscosity with 
	the value at the centre of the face, while we approximate the derivative of 
	the velocity with a centred finite difference:
	\begin{equation}
	\int_{e_u} \nu_\text{eff} \frac{\partial u}{\partial x} \; dA \approx 
	\nu_{\text{eff},\{I+1,J\}} \frac{u_{i+1,J} - u_{i,J}}{x_{i+1}-x_i} |e_u|.
	\end{equation}
	For the lateral momentum flux we split the 	face $n_u$ into the two halves 
	related to the two cells $[x_{i-1},x_i]\times[y_{j-1},y_j]$ and 
	$[x_i,x_{i+1}]\times[y_{j-1},y_j]$:
	\begin{equation}
	n_u = [x_I,x_i]\times \{y_j\} \cup [x_i,x_{I+1}] \times \{y_j\}.
	\end{equation}
	We employ again a centred finite difference to approximate the 
	derivative of the velocity, while, for the approximation of the viscosity, 
	we compute an average between the two cells sharing the face:
	\begin{equation}
	\int_{n_u} \nu_\text{eff} \frac{\partial u}{\partial y} \; dA = 
	\int_{x_{I,j}}^{x_{i,j}} \nu_\text{eff} \frac{\partial u}{\partial y} \; dA 
	+\int_{x_{i,j}}^{x_{I+1,j}} \nu_\text{eff} \frac{\partial u}{\partial y} \; 
	dA,
	\end{equation}
	\begin{equation*}
	\int_{x_{I,j}}^{x_{i,j}} \nu_\text{eff} \frac{\partial u}{\partial y} \; dA 
	\approx \frac{1}{2}\big(\nu_{\text{eff},\{I,J\}}+\nu_{\text{eff},\{I,J+1\}} 
	\big) \frac{u_{i,J+1}-u_{i,J}}{y_{J+1}-y_J} \frac{|n_u|}{2},
	\end{equation*}
	\begin{equation*}
	\int_{x_{i,j}}^{x_{I+1,j}} \nu_\text{eff} \frac{\partial u}{\partial y} \; 
	dA \approx \frac{1}{2}\big( \nu_{\text{eff},\{I+1,J\}}+ 
	\nu_{\text{eff},\{I+1,J+1\}} \big) \frac{u_{i,J+1}-u_{i,J}}{y_{J+1}-y_J} 
	\frac{|n_u|}{2}.
	\end{equation*}
	%
	\item in the convective term we have again both a frontal momentum flux 
	contribution from the faces $e_u$ and $w_u$ and a lateral momentum flux 
	contribution from the faces $n_u$ and $s_u$:
	\begin{multline}
	\int_{\partial V_u} u (\mathbf{v} \cdot \mathbf{n}) \; dA = \int_{e_u} u u 
	\; dA - \int_{w_u} u u \; dA \; +\\
	+ \int_{n_u} u v \; dA  -\int_{s_u} u v \; dA.
	\end{multline}
	For the discretization we have to distinguish between the 
	\emph{transporting velocity}, coming from $\mathbf{v} \cdot \mathbf{n}$, 
	and the \emph{transported field}, that in this case is the velocity itself. 
	For the former we average between the values sharing the face, 
	while for the latter we have to consider an approximation that takes into 
	account the flow direction, as it will be explained in detail in 
	Subsections~\ref{subsec:diffscheme} and \ref{subsec:tvd}. For the moment we 
	simply denote this approximation with a superscript $^*$.
	We develop only the contributions from $e_u$ and $n_u$, the other two are 
	analogous.\\
	For the frontal momentum flux we approximate the transporting velocity with 
	an average between the values at the centre of the two staggered cells 
	sharing the staggered face:
	\begin{equation}
		\int_{e_u} u u \; dA \approx u^* \frac{u_{i,J} + 
		u_{i+1,J}}{2}|e_u|.
	\end{equation}
	For the lateral momentum flux we approximate the transporting velocity with 
	an average between the values a the two ends of the face (see 
	Figure~\ref{fig:lat_adv_flux}):
	\begin{equation}
	\int_{n_u} u v \; dA \approx u^* \frac{v_{I,j} 
	+v_{I+1,j}}{2} |n_u|.
	\end{equation}
	\begin{figure}
		\centering
		\includegraphics[width=0.6\textwidth]{lateral_adv_flux_black.pdf}
		\caption[Degrees of freedom involved in the lateral part of the 
		advective flux]{Degrees of freedom involved in the lateral part of the 
		advective flux.}
		\label{fig:lat_adv_flux}
	\end{figure}
\end{itemize}
The equation for the component $v$ of the velocity is analogous to the one for 
$u$ described above, with the only addition of the gravity term:
\begin{equation}
\frac{\partial v}{\partial t} + \nabla \cdot (v \mathbf{v}) - \nabla \cdot 
(\nu_\text{eff} \nabla v) + \frac{1}{\varrho}\frac{\partial}{\partial y} \big(p 
+ \varrho k\big) - g= 0,
\end{equation}
with $g = \SI{-9.81}{m/s}$. The gravity term is discretized straight-forward:
\begin{equation}
\int_{V_v} g \; dV = g |V_v|,
\end{equation}
where $V_v = [x_{i-1}, xi] \times [y_J, y_{J+1}]$ is the ``blue'' control 
volume in 
Figure~\ref{fig:staggrid}. 

%
\subsection{Differencing schemes} \label{subsec:diffscheme} %Linear 
%differencing schemes ?
The choice of the scheme for the approximation of a transported field is of 
great importance for both the accuracy and the stability of the solution of the 
problem. In general this decision has to be taken for every convective term, 
indeed we have found it both in the discretization of the velocity 
equation and of the turbulence model equations. As already mentioned, an 
important property that the scheme should have is the \emph{transportativeness} 
(see \cite{main:vermal}), i.e. it should take into account the direction of the 
flow. From a physical point of view this comes from the fact that, when in a 
flow convection is dominating over diffusion, a bias of the value on the face 
towards the direction where the flow comes from must occur. From a mathematical 
point of view instead we can introduce the following \emph{PÃ©clet number}
\begin{equation}
	Pe = \frac{|u| h}{2\nu},
\end{equation}
where $h$ denotes the cell width. When the grid is too coarse or the viscosity 
is too low $Pe\rightarrow\infty$, and this can lead to a lost of stability of 
the numerical method (see for example \cite{main:quarteroni}).

In the following we will list the most immediate options, referring to the 
convective term of the equation~\eqref{eq:stagu} for the $x$-component of the 
velocity. It is considered here the case of a uniform grid, with positive 
transporting velocity according to 
Figure~\ref{fig:superscripts}, but all the schemes can be generalized to the 
case of non-uniform grids. Moreover the basic construction is one-dimensional, 
so it can be used for every dimension also in a multi-dimensional problem. For 
a complete description see for example in \cite{main:vermal}.
\begin{figure}
	\centering
	\includegraphics[width=0.75\textwidth]{trecelle_black.pdf}
	\caption[Location of the degrees of freedom used to approximate 
	$u^*$]{Location of the degrees of freedom used to approximate $u^*$. The 
	superscripts $^U$, $^{FU}$, $^D$ and $^{FD}$ stand respectively for 
	upstream, far-upstream, downstream and far-downstream. They hold for the 
	case of positive transporting velocity at the face where $u^*$ is.}
	\label{fig:superscripts}
\end{figure}
\subsubsection{CD scheme}
The Central Differencing (CD) scheme consists in using an average between the 
two first neighbouring values:
\begin{equation} \label{eq:cd}
	u^* = \frac{u^D + u^U}{2}.
\end{equation}
Employing Taylor expansions, it can be easily seen that this approximation is 
of second order, but being symmetric it does not have the transportativeness 
property. Indeed it can be shown that when $Pe > 1$ it is not stable.
%
\subsubsection{Upwind scheme}
In opposition to the CD scheme, the upwind scheme consists in using only the 
upstream value:
\begin{equation}
	u^* = u^U
\end{equation}
It is a simple, widely used and robust scheme as it has the transportativeness 
property, but its accuracy is only of first order, indeed it introduces in the 
solution an important amount of numerical diffusion that smooths the gradients. 
%
\subsubsection{Hybrid scheme}
The hybrid scheme (\cite{diff:hybrid}) consists in evaluating if $Pe<1$ or 
$Pe>1$ at each face and then employing the CD or the upwind respectively. It 
exploits the good properties of the two schemes mentioned above, so it is 
highly stable and accurate when the diffusion is dominant, however the overall 
accuracy in terms of Taylor expansions reduces to first order.
%
\subsubsection{QUICK scheme}
The Quadratic Upstream Interpolation for Convective Kinetics (QUICK) scheme 
(\cite{fv:leonard}) is an higher-order method that involves an extended stencil 
of degrees of freedom. It can be obtained evaluating the quadratic interpolator 
of $u^D$, $u^U$ and 
$u^{FU}$ at the position where $u^*$ is:
\begin{equation} \label{eq:quick}
	u^* = \frac{3u^D + 6u^U - u^{FU}}{8}.
\end{equation}
Its accuracy is of third order, but it may produce unphysical overshoots or 
undershoots in the solution when there are strong gradients. This behaviour is 
not desirable, in particular in the case where the simulation involves 
quantities such as the turbulent kinetic energy $k$ that have to be positive. 
%
\subsubsection{LUD scheme}
The Linear Upwind Differencing (LUD) scheme is an extension of the upwind 
scheme that has a second order accuracy, however it can produce too unphysical 
oscillations. It can be obtained evaluating the linear interpolator of $u^U$ 
and 
$u^{FU}$ at the position where $u^*$ is:
\begin{equation} \label{eq:lud}
u^* = \frac{3u^U - u^{FU}}{2}
\end{equation}
%
\subsubsection{An example}
We can see the behaviour of the CD, Upwind and QUICK methods when they are 
applied to a one-dimensional scalar conservation law:
\begin{align}
	\label{eq:1dconslaw} \frac{\partial \phi}{\partial t} + \frac{\partial 
	\phi}{\partial x} = 0, 
	\quad &\forall x \in (0, 1), \; \forall t > 0\\
	\phi(0, t) = 1, \quad &\forall t>0\\
	\label{eq:1dconslawend}\phi(x, 0) = 0, \quad &\forall x \in (0,1)
\end{align}
In this case there is no diffusion but only the linear transport of a step from 
left to right. The equation~\eqref{eq:1dconslaw} can be discretized with finite 
volumes storing the degrees of freedom at the ends of each cells, as it is in 
the staggered grid concept. Then the differencing schemes presented above can 
be applied to the discretization of the transport term, while for the temporal 
discretization we can use the Backward Euler method (see 
Subsection~\ref{subsec:time}).
\begin{figure}[t]
	\centering
	\input{../img/1Dconslaw_report}
	\caption[Solution of a one-dimensional scalar conservation law]{Solution of 
	the problem \eqref{eq:1dconslaw}--\eqref{eq:1dconslawend} at the time 
	$t=0.5$. The upwind method smooths the gradient, while the CD and QUICK 
	methods produce oscillations.}
	\label{fig:1dconslaw}
\end{figure}

In Figure~\ref{fig:1dconslaw} we can see the solution at $t=0.5$. The upwind 
method is very diffusive near the step, but bounded within the extrema of the 
exact solution. The CD and QUICK methods instead approximate better the steep 
gradient, but produce oscillations for $x<0.5$.
%
\subsection{TVD methods} \label{subsec:tvd}
Total Variation Diminishing (TVD) methods belong to a category of methods 
called \emph{high resolution methods}, that address the problem of computing a 
solution without any oscillation and with an higher order accuracy, second 
order in this case. They were originally developed for scalar conservation laws 
of the type:
\begin{align}
	\label{eq:conslaw} &\frac{\partial \phi}{\partial t} + \frac{\partial f(x) 
	}{\partial x} = 0. 
%\quad t>0 \quad x 
%	\in 
%	\mathbb{R}\\[1ex]
%	\label{eq:conslawic} &\phi(x, 0) = \phi_0(x), \quad x \in \mathbb{R}
\end{align}

For this kind of problems the \emph{total variation} of the numerical solution 
can be defined as:
\begin{equation}
	TV(\phi) = \sum_{i=1}^{N_\text{dof}-1} |\phi_{i+1} - \phi_i|,
\end{equation}
where $\phi_i$ is the numerical solution at the node $i$ of the discretized 
domain. A method is called TVD if the total variation of the 
solution does not increase with time: 
\begin{equation}\label{eq:tvdcondition}
	TV(\phi ^{n+1}) \leq TV(\phi^n) \quad \forall n>0,
\end{equation}
where $\phi^n$ is the numerical solution at the time-step $t^n$. In 
\cite{tvd:monotonicity} it has been proved that a TVD scheme is 
\emph{monotonicity preserving}, i.e. it does not create new 
local extrema, local minima are non-decreasing and local maxima are 
non-increasing. This is the desirable property that we would like to have in 
order avoid the creation of solutions containing overshoots and undershoots, 
as it happens using the higher order methods presented in the previous 
subsection.

According to \cite{tvd:sweeby} and \cite{main:darwish} we can achieve our 
target adding to the first order upwind approximation a second order 
non-linear 
anti-diffusive flux: 
\begin{equation} \label{eq:tvdformula}
u^* = u^U + \frac{1}{2}\psi(r)(u^D - u^U), \quad r = 
\frac{u^U - u^{FU}}{u^D - u^U}.
\end{equation}
The flux includes a function $\psi$ called \emph{flux limiter}, indeed it 
should dampen the flux contribution in regions of the domain where it 
could produce oscillations. It is chosen non-negative in order to preserve the 
sign of the flux and it depends on the variable $r$, that is defined as the 
ratio between two consecutive differences of the solution. The non-linearity 
can not be avoided, indeed it was proved by \textcite{tvd:godunov} that any 
monotonicity preserving linear scheme can be at most first order accurate.

Exploiting the approximation \eqref{eq:tvdformula} to solve a problem like
\eqref{eq:conslaw} and imposing the TVD condition \eqref{eq:tvdcondition} on 
the solution, we obtain the following bounds for the flux limiter function:
\begin{align}
\notag \psi(r) = 0 \quad &\text{if} \quad r < 0\\
\psi(r) \leq \min \{2r, 1\} \quad &\text{if} \quad 0 \leq r \leq 1\\
\notag \psi(r) \leq 2 \quad &\text{if} \quad r > 2
\end{align}
Notice that when $r<0$ we are in presence of a local maximum or minimum, 
because it means that the differences between the upstream and downstream nodes 
and the one between the far upstream and upstream nodes have opposite signs. 
When this happens, $\psi$ is set to zero, so only the first order upwind 
contribution is employed in the approximation of $u^*$.
It is also required to $\psi$ to fulfil the following symmetry property:
\begin{equation}
\frac{\psi(r)}{r} = \psi\bigg(\frac{1}{r}\bigg),
\end{equation}
which ensures that backward- and forward-facing gradients are treated in the 
same way.

In order to have a second order scheme, $\psi$ must be at least 
Lipschitz-continuous. Moreover, following \cite{tvd:sweeby} and 
\cite{tvd:vanleer}, any second order scheme 
can be obtained as a convex combination of the CD scheme \eqref{eq:cd} and the 
LUD scheme \eqref{eq:lud}, in the following way:
\begin{equation}
	\psi(r) = \theta(r) \psi_{CD}(r) + (1-\theta(r))\psi_{LUD}(r) \quad \forall 
	r >0,
\end{equation}
where $\theta(r)$ is a parameter such that $0 \leq \theta(r) \leq 1,\; \forall 
r>0$, while $\psi_{CD}$ and $\psi_{LUD}$ are the linear flux limiter functions 
that can be associated to the schemes CD and LUD rearranging the 
approximations \eqref{eq:cd} and \eqref{eq:lud}:
\begin{gather}
	\psi_{CD}(r) = 1 \quad \forall r,\\
	\psi_{LUD}(r) = r \quad \forall r.
\end{gather}
Thus, adding these requirements to the previous ones, we 
obtain the following bounds for the flux limiter function of a TVD method:
\begin{align}
\psi(r) = 0 \quad &\text{if} \quad r < 0 \notag \\
\label{eq:tvdbounds} r \leq \psi(r) \leq \min \{2r, 1\} \quad &\text{if} \quad 
0 
\leq r \leq 1\\
1 \leq \psi(r) \leq \min \{r, 2 \} \quad &\text{if} \quad r > 2 \notag
\end{align}
In Figure~\ref{fig:tvdregion} they are reported in a $\psi-r$ diagram known 
also as Sweby's diagram.
\begin{figure}
	\centering
	\input{../img/Tvd_region}
	\caption[TVD region (Sweby's diagram)]{In grey the TVD region in which 
	the flux 
	limiter functions must fit. It is called also Sweby's diagram.}
	\label{fig:tvdregion}
\end{figure}
% A livello teorico potrei aggiungere la dimostrazione di monotonicity->TVD, 
%l'applicazione di TVD per ottenere i bounds e l'applicazione dei bounds 
%all'approssimazione col flux limiter (come in sweby o in darwish). Potrei 
%mettere qualcosa nell'appendice.
\subsubsection{Flux limters}
Starting from the bounds \eqref{eq:tvdbounds}, it is easy to create a 
flux limiter function, indeed in literature many possible choices can be 
found. 
We list here some of the most popular functions that have been implemented in 
\DUMUX and in Figure~\ref{fig:fluxlimiters} we can see their graph in the 
Sweby's diagram:
\begin{itemize}
	\item Van Leer \cite{tvd:vanleer}
	\begin{equation} \label{eq:vl}
	\psi(r) = \frac{r+|r|}{1+r}.
	\end{equation}
	It is a smooth function that asymptotically reaches 2 for $r \rightarrow 
	\infty$.
%
	\item Van Alabada \cite{tvd:vanalabada}
	\begin{equation} \label{eq:vanalabada}
	\psi(r)=
	\begin{cases}
	\dfrac{r^2+r}{r^2+1} \quad &\text{if $r\geq 0$}\\[2ex]
	0 \quad &\text{if $r<0$}
	\end{cases}
	\end{equation}
	It is a smooth function that instead goes to 1 as $r \rightarrow \infty$.
%
	\item Min-Mod \cite{tvd:roe}
	\begin{equation} \label{eq:minmod}
	\psi(r) = \max \{0, \min \{ r,1\} \}
	\end{equation}
	It is a piecewise linear function that lies on the lower boundary of the 
	TVD region. Intuitively, using this limiter we add to the upstream value  
	half of	the smallest increment in absolute value between $u^U-u^{FU}$ and 
	$u^D - u^U$.
%
	\item Superbee \cite{tvd:roe}
	\begin{equation} \label{eq:superbee}
	\psi(r)=\max \{0, \min \{ 2r, 1\}, \min \{ r, 2\} \}
	\end{equation}
	It is a piecewise linear function that lies on the upper boundary of the 
	TVD region.
%
	\item UMIST \cite{tvd:lien}
	\begin{equation} \label{eq:umist}
	\psi(r)=\max \bigg\{0, \min \bigg\{ 2r, \frac{3r+1}{4},\frac{r+3}{4}, 
	2\bigg\} \bigg\}
	\end{equation}
	It is a piecewise linear function that was designed as a symmetrical TVD 
	version of QUICK.
%
	\item MC (Monotinized Central) limiter \cite{tvd:mclimiter}
	\begin{equation} \label{eq:mclim}
	\psi(r)=\max \bigg\{0, \min \bigg\{ 2r, \frac{r+1}{2}, 2\bigg\} \bigg\}
	\end{equation}
	It is also known as MUSCL (Monotonic Upstream-Centred Scheme for 
	Conservation Laws) limiter.
%	
%	\item WAHYD \cite{nonunif:hou}
%	\begin{equation}
%	\psi(r)=
%	\begin{cases}
%	\dfrac{r + |r|}{r + 1} & \text{if $r \leq 1$} \\[2ex]
%	\min \bigg\{ \dfrac{r + 2 r^2}{2 + r^2}, 2 \bigg\} & \text{if $r>1$}
%	\end{cases}
%	\end{equation}
%	It is a hybrid scheme, for $r\leq 1$ it is the Van Leer scheme 
%	\eqref{eq:vl}, while for $r>1$ it is closer to the upper bound of the TVD 
%	region.
\end{itemize}
\begin{figure}[t]
	\centering
	\input{../img/flux_limiters}
	\caption[Flux limiter functions]{The Sweby's diagram with the flux limiters 
	presented in this section as functions of $r$.}
	\label{fig:fluxlimiters}
\end{figure}

It is not easy to compare the different flux limiters in order to find the 
best one. Generally the Van Alabada and the Min-Mod can be a bit less accurate 
since $\psi \rightarrow 1$ as $r \rightarrow \infty$, while a scheme like the 
Superbee can produce sharper gradients, but sometimes the convergence can be a 
bit more difficult (it is said to be too compressive). The UMIST instead has a 
more complex function, so its evaluation can be more expensive. However their 
performances should be compared case by case.

In Figure~\ref{fig:1dconslawtvd} we can see the application of the TVD method 
using the Van Leer flux limiter \eqref{eq:quick:vl} to the problem 
\eqref{eq:1dconslaw}--\eqref{eq:1dconslawend}. It can be observed that the 
gradient is approximated with the same accuracy of the QUICK scheme 
\eqref{eq:quick}, but the overshoot for $x<0.5$ is avoided.
\begin{figure}
	\centering
	\input{../img/1DconslawTVD_report}
	\caption[Solution of a one-dimensional scalar conservation law with the TVD 
	method]{Solution of the problem 
	\eqref{eq:1dconslaw}--\eqref{eq:1dconslawend} at the time 
	$t=0.5$. The TVD method approximates the gradient as accurately as the 
	QUICK method but does not produce any overshoot for $x<0.5$.}
	\label{fig:1dconslawtvd}
\end{figure}
%
\subsubsection{Non-uniform grids}
The theory of TVD methods presented above holds for structured grids. In order 
to deal with Cartesian non-uniform grids, that for example employ a grading, we 
have to generalize it considering the information about the distances between 
the degrees of freedom involved in the approximation. The generalization has 
always to be consistent, i.e. the approximation~\eqref{eq:tvdformula} has to be 
recovered in case of uniform grid. In literature several slightly different 
approaches can be found, see for example \cite{nonunif:bruner}, 
\cite{nonunif:darmou}, \cite{nonunif:li}, \cite{nonunif:berger}, 
\cite{nonunif:hou} and \cite{nonunif:zeng}. We describe here some of them.

A first simple approach consists in modifying the value of $u^{FU}$ appearing 
in the factor $r$ defined in \eqref{eq:tvdformula}.
\begin{figure}
	\centering
	\includegraphics[width=0.75\textwidth]{non_uniform_cells_black.pdf}
	\caption[Non-uniform staggered grid]{Non-uniform staggered grid. The 
	distance between $u^{FU^*}$ and $u^U$ is the same that there is between 
	$u^U$ and $u^D$.}
	\label{fig:nonunifli}
\end{figure}

The idea is that if the grid is not uniform, the distances between $u^D$ and 
$u^U$ and between $u^U$ and $u^{FU}$ might be different, as it is represented 
in Figure~\ref{fig:nonunifli}. In this situation the formula 
\eqref{eq:tvdformula} can not be used directly, because the degree of freedom 
$u^{FU}$ is not at the position 
$u^{FU^*}$, where it would be if the grid was uniform, with cell sizes equal to 
the distance between $u^U$ and $u^D$, i.e. at the position upstream with 
respect to $u^U$, at a distance equal to the one between $u^U$ and $u^D$, see 
Figure~\ref{fig:nonunifli}. We want to use the ratio:
\begin{equation*}
r = \frac{u^U - u^{FU^*}}{u^D - u^U},
\end{equation*}
thus we need to build an approximation for $u^{FU^*}$.

\textcite{nonunif:darmou} proposed the following scheme that 
approximates the difference $u^D - u^{FU^*}$:
\begin{equation}
r = \frac{u^U - u^{FU^*}}{u^D - u^U} = \frac{(u^D - u^{FU^*})-(u^D - u^U)}{u^D 
- u^U} = \frac{u^D - u^{FU^*}}{u^D - u^U} - 1,
\end{equation}
\begin{equation}
u^D - u^{FU^*} \approx \frac{du^U}{dx} r_{ \scriptscriptstyle FU^*, D} = 2 
\frac{du^U}{dx} r_{\scriptscriptstyle U, D},
\end{equation}
where $r_{ \scriptscriptstyle A, B} $ denotes the vector from the point $A$ to 
$B$. \textcite{nonunif:li} showed that this method behaves well with parabolic 
solutions, but not so well with exponential solutions. So they proposed an 
improved approximation which introduces more upwind information:
\begin{equation}
r = \frac{u^U - u^{FU^*}}{u^D - u^U}, \quad u^{FU^*} \approx u^{FU} + 
\frac{d u^{FU}}{dx} r_{\scriptscriptstyle FU, FU^*}.
\end{equation}

\textcite{nonunif:hou} introduced a different and more rigorous approach. The 
idea in order to improve those described above was derived to consider not only 
the distances between the degrees of freedom, but also the sizes of the cells 
around them. Let us consider for example a non-uniform staggered grid as in 
Figure~\ref{fig:hou}.
\begin{figure*}[h]
	\centering
	\includegraphics[width=\textwidth]{cells_with_sizes.pdf}
	\caption[Non-uniform staggered grid with cell sizes]{Non-uniform staggered 
	grid with cell sizes.}
	\label{fig:hou}
\end{figure*}
\\We generalize \eqref{eq:tvdformula} in the following way:
\begin{equation}
u^* = u^U + \frac{1}{\RUD} \psi(r) (u^D - u^U),
\end{equation}
\begin{equation}
\RUD = \frac{\Delta \xU + \Delta \xD}{\Delta \xU}, \quad r = \frac{u^U - 
u^{FU}}{x^U - x^{FU}} \cdot \frac{x^D - x^U}{u^D - u^U}.
\end{equation}
$\RUD$ takes into account the sizes of the upstream and downstream 
staggered cells, while $r$ is modified into ratio between an approximation of 
the gradients. Notice that if the grid is uniform $\RUD = 2$, as in the uniform 
formula \eqref{eq:tvdformula}.

Repeating the procedure described in the Subsection~\ref{subsec:tvd}, the TVD 
condition \eqref{eq:tvdcondition} and the second order accuracy are imposed, 
obtaining the following modified bounds for the flux limiter function $\psi$:
\begin{align}
\notag \psi(r) = 0 \quad &\text{if} \quad r < 0\\
r \leq \psi(r) \leq \min \bigg \{\frac{\RFUU}{\RFUU - 1}, 1 \bigg \} \quad 
&\text{if} \quad 0 \leq r \leq 1\\
\notag 1 \leq \psi(r) \leq \min \{r,\RUD \} \quad &\text{if} \quad r > 2
\end{align}
In Figure~\ref{fig:tvdregionhou} we can see the modified TVD region; with 
respect to Figure~\ref{fig:tvdregion}, the upper bounds are changed.
\begin{figure}[t]
	\centering
	\input{../img/tvd_region_modified_hou_final_report}
	\caption[Modified TVD region]{In grey the modified TVD region for 
	non-uniform grids in which the flux limiter functions must fit 
	\cite{nonunif:hou}.}
	\label{fig:tvdregionhou}
\end{figure} 
At last the flux limiter functions \eqref{eq:vl}--\eqref{eq:mclim} have to be 
generalized in order to fit into these new bounds.

\section{Cell-centred concept}
In the porous-medium region $\Omega_\text{pm}$ we have to solve only a steady 
scalar equation, with the 
pressure as a primary variable, indeed, due to the incompressibility of the 
fluid, the time derivative is not present:
\begin{align}
\label{eq:cellcentred}	\nabla \cdot \mathbf{v} = 0&\\
\label{eq:forch2}	\mathbf{v} + C_F \sqrt{\mathbf{K}} \frac{\varrho}{\mu} 
	|\mathbf{v}|\mathbf{v} + \frac{1}{\mu} \mathbf{K}(\nabla p - \varrho 
	\mathbf{g} ) = \mathbf{0}&
\end{align}
We employ a cell-centred finite volumes method, so the degrees of freedom of 
the pressure are located at the centre of each cell, as we can see in 
Figure~\ref{fig:cellcentred}, and the cells of the grid correspond to the 
control volumes.
\begin{figure}
	\centering
	\includegraphics[width=0.4\textwidth]{cellcentred.pdf}
	\caption[Cell-centred grid]{Location of the degrees of freedom within a 
	cell-centred approach.}
	\label{fig:cellcentred}
\end{figure}

Let us integrate the equation \eqref{eq:cellcentred} over a control volume 
$V_L$ (see Figure~\ref{fig:cctpfa}) and apply the Gauss's divergence theorem:
\begin{equation}
\int_{V_L} \nabla \cdot \mathbf{v} \; dV = \int_{\partial V_L} \mathbf{v} \cdot 
\mathbf{n} \; dA.
\end{equation}
The Forchheimer's law \eqref{eq:forch2} is non-linear, so we use the Newton's 
method in order to compute the velocity, i.e. the flux over the boundary 
$\partial 
V_L$:
\begin{align}
	\mathbf{J}_f(\mathbf{v}^k) \delta \mathbf{v}^{k+1} =& 
	-\mathbf{f}(\mathbf{v}^k), \quad \text{$\forall k\geq 0$ until 
	convergence}\\
	\mathbf{v}^{k+1} =& \mathbf{v}^k + \delta \mathbf{v}^{k+1}
\end{align}
where
\begin{equation} \label{eq:resforch}
	\mathbf{f}(\mathbf{v}) = \mathbf{v} + C_F \sqrt{\mathbf{K}} 
	\frac{\varrho}{\mu} 
	|\mathbf{v}|\mathbf{v} + \frac{1}{\mu} \mathbf{K}(\nabla p - \varrho 
	\mathbf{g} )
\end{equation}
and $\mathbf{J}_f(\mathbf{v})$ is its Jacobian matrix:
\begin{equation} \label{eq:jacforch}
\mathbf{J}_f(\mathbf{v}) = \mathbb{1} + 
C_F\sqrt{\mathbf{K}}\frac{\varrho}{\mu}\big(|\mathbf{v}|\mathbb{1} + 
\frac{1}{|\mathbf{v}|}{\mathbf{v}\mathbf{v}^\mathrm{T}}\big).
\end{equation}
We use as initial guess $\mathbf{v}^0$ the velocity computed with the Darcy's 
law \eqref{eq:darcy}.

The evaluation of \eqref{eq:resforch} and \eqref{eq:jacforch} over $\partial 
V_L$ is performed with a Two Point Flux Approximation (TPFA) method, which 
consists in exploiting the values of the two cells sharing the face; it is a 
simple but robust method, commonly used in commercial software.
\begin{figure}
	\centering
	\includegraphics[width=0.6\textwidth]{cctpfa3.pdf}
	\caption[Two cells $V_L$ and $V_R$ sharing the face $\sigma$]{Two cells 
	$V_L$ and $V_R$ sharing the face $\sigma$.}
	\label{fig:cctpfa}
\end{figure}
Let us consider for instance the face $\sigma = \partial V_L \cup \partial 
V_R$, according to Figure~\ref{fig:cctpfa}, and let the permeability tensor be 
diagonal so that it act as a scalar. We approximate the derivative of the 
pressure $\partial p /\partial 
x$ with a centred finite difference:
\begin{equation}
\frac{\partial p}{\partial x} \approx \frac{p_R-p_L}{x_R -x_L}.
\end{equation}
We approximate the permeability $\mathbf{K}$ with its value at 
$\mathbf{x}_\sigma$, while 
for the viscosity $\mu$ (and eventually the density $\varrho$) we employ the 
upwind value.

In case of discontinuous permeabilities at the face $\sigma$, an harmonic 
average weighted on the distances between the cell centres and the face is 
performed:
\begin{equation}
\frac{|x_R - x_L|}{\mathrm{K}} \approx 
\frac{|x_\sigma - x_L|}{\mathrm{K}_L}+\frac{|x_R - x_\sigma|}{\mathrm{K}_R}.
\end{equation}

These formulas for the TPFA approximation are the simplified version for a 
Cartesian grid, while in the general case of an unstructured grid the method is 
derived exploiting a decomposition of the vector
\begin{equation}
\mathbf{d}_{L,\sigma}=\mathbf{x}_\sigma - \mathbf{x}_L,
\end{equation}
based the co-normal vector $\mathbf{Kn}_L$. Moreover it 
can be shown that this approximation is consistent only if the grid is 
K-orthogonal, i.e. if $\mathbf{Kn}_L$ is parallel to $\mathbf{d}_{L, \sigma}$ 
(see \cite{tesi:wolff}).
%\section{Coupling conditions}
% Disegno di cosa succede all'interfaccia
% Not sure about this section...
\section{Time discretization} \label{subsec:time}
For the temporal discretization we employ fully implicit, unconditionally 
stable methods as the Backward Euler (BE) and the Backward Differencing Formula 
2 (BDF2) also for non constant time steps. A monolithic approach is used, the 
Jacobian matrix is computed 
numerically then the UMFPACK solver is used. The time-step size depends of the 
convergence of the Newton's method at the previous time iteration.
\section{Summary}
Fully implicit coupling, monolithic approach, UMFPACK, cenni alle coupling 
conditions and boundary conditions, primary variables.